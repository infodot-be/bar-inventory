{% extends 'base.html' %}
{% load stock_filters %}

{% block title %}Stock Overview - Bar Inventory{% endblock %}

{% block extra_head %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<!-- Chart utilities -->
{% load static %}
<script src="{% static 'stock/js/chart-utils.js' %}"></script>
{% endblock %}

{% block extra_css %}
<style>
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 30px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="text-center mb-4">
            <i class="bi bi-bar-chart-fill"></i> Stock Overview
            {% if selected_location %}
            - {{ selected_location.name }}
            {% endif %}
        </h2>
    </div>
</div>

{% if not selected_location %}
<!-- Location Summaries -->
<div class="row mb-4">
    <div class="col-12">
        <h4 class="mb-3"><i class="bi bi-geo-alt"></i> Stock by Location</h4>
    </div>
    {% for summary in location_summaries %}
    <div class="col-md-6 col-lg-4 mb-3">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-building"></i> {{ summary.location.name }}
                </h5>
                <div class="text-center mt-3">
                    <div class="text-muted small">Items</div>
                    <h4 class="mb-0">{{ summary.item_count }}</h4>
                </div>
                <div class="d-grid gap-2 mt-3">
                    <a href="{% url 'stock:location_detail' summary.location.id %}" class="btn btn-primary btn-sm">
                        <i class="bi bi-box-seam"></i> View Stock
                    </a>
                    <a href="{% url 'stock:overview_location' summary.location.id %}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-bar-chart"></i> View Overview
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-12">
        <div class="alert alert-info text-center">
            <i class="bi bi-info-circle"></i> No locations with stock data available.
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

{% if selected_location and chart_data %}
<!-- Combined Chart for All Beverages -->
<div class="row mb-4">
    <div class="col-12">
        <h4 class="mb-3"><i class="bi bi-graph-up"></i> Stock Overview</h4>
        <div class="card">
            <div class="card-body">
                <div style="position: relative; height: 400px;">
                    <canvas id="chart-combined"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Time Series Charts for Each Beverage -->
<div class="row mb-4">
    <div class="col-12">
        <h4 class="mb-3"><i class="bi bi-graph-up"></i> Trends ({{ current_time|date:"d/m H:i" }})</h4>
    </div>
    {% for beverage in all_beverages %}
    <div class="col-md-6 mb-4">
        <div class="card" id="card-{{ beverage.id }}">
            <div class="card-body">
                <h6 class="card-title">
                    {{ beverage.name|title }} ({{ beverage.unit_type }})
                    <span id="trend-{{ beverage.id }}" class="ms-2"></span>
                </h6>
                <div class="chart-container">
                    <canvas id="chart-{{ beverage.id }}"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Recent Stock Counts -->
<div class="row">
    <div class="col-12">
        <h4 class="mb-3"><i class="bi bi-clock-history"></i> Recent Stock Counts</h4>
        <div class="card">
            <div class="card-body">
                {% if count_data %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                {% for beverage in all_beverages %}
                                <th class="text-center">{{ beverage.name|title }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for data in count_data %}
                            <tr>
                                <td>{{ data.count.timestamp|date:"d/m H:i" }}</td>
                                {% for beverage in all_beverages %}
                                <td class="text-center">
                                    {% with qty=data.beverages|get_item:beverage.id %}
                                        {% if qty %}{{ qty }}{% else %}â€”{% endif %}
                                    {% endwith %}
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-center text-muted mb-0">
                    <i class="bi bi-info-circle"></i> No stock counts recorded yet.
                </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{% if selected_location and chart_data %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chartData = {{ chart_data|safe }};
    {% if DEBUG %}console.log('Chart data loaded:', chartData);{% endif %}

    // Create a chart for each beverage
    {% for beverage in all_beverages %}
    (function() {
        const beverageId = {{ beverage.id }};
        const data = chartData[beverageId];
        {% if DEBUG %}console.log('Beverage', beverageId, 'data:', data);{% endif %}

        if (data && data.labels && data.labels.length > 0) {
            const alarmMin = data.alarm_minimum || 0;
            const beverageColor = data.color || 'rgb(54, 162, 235)';
            const trendResult = calculateTrendline(data.data, data.labels, alarmMin);

            // Get the last actual timestamp for calculating future timestamps
            const lastTimestamp = parseDate(data.labels[data.labels.length - 1]);

            // Calculate average minutes between counts for future predictions
            const avgMinutes = trendResult.extendedLabels.length > data.labels.length ? 15 : 30;

            // Convert labels to timestamps for time scale
            const timestamps = createTimestampsWithPredictions(
                trendResult.extendedLabels,
                data.labels[data.labels.length - 1],
                avgMinutes
            );

            // Convert data to {x, y} format for time scale
            const quantityData = trendResult.extendedLabels.map((label, index) => {
                const value = index < data.data.length ? data.data[index] : null;
                return value !== null ? { x: timestamps[index], y: value } : null;
            }).filter(point => point !== null);

            const trendData = timestamps.map((timestamp, index) => ({
                x: timestamp,
                y: trendResult.trendline[index]
            }));

            const ctx = document.getElementById('chart-' + beverageId).getContext('2d');

            const datasets = [{
                label: '{{ beverage.name|title }}',
                data: quantityData,
                borderColor: beverageColor,
                backgroundColor: beverageColor.replace('rgb', 'rgba').replace(')', ', 0.1)'),
                tension: 0.4,
                fill: true,
                order: 2,
                spanGaps: false
            }, {
                label: 'Trend',
                data: trendData,
                borderColor: 'rgba(54, 162, 235, 0.5)',
                borderDash: [5, 5],
                borderWidth: 2,
                fill: false,
                tension: 0,
                pointRadius: 0,
                order: 1
            }];

            // Add crossing point markers if they exist
            const crossingAnnotations = {};
            if (trendResult.crossingPoints && trendResult.crossingPoints.length > 0) {
                const crossingData = trendResult.crossingPoints.map(crossing => {
                    const index = Math.round(crossing.index);
                    if (index >= 0 && index < timestamps.length) {
                        return { x: timestamps[index], y: crossing.value };
                    }
                    return null;
                }).filter(point => point !== null);

                datasets.push({
                    label: 'Alert Crossing',
                    data: crossingData,
                    borderColor: 'rgba(255, 0, 0, 0.8)',
                    backgroundColor: 'rgba(255, 0, 0, 0.8)',
                    pointRadius: 8,
                    pointStyle: 'triangle',
                    showLine: false,
                    order: 0
                });

                // Create annotations for crossing point labels using utility function
                trendResult.crossingPoints.forEach((crossing, idx) => {
                    const index = Math.round(crossing.index);
                    if (index >= 0 && index < timestamps.length) {
                        const timestamp = timestamps[index];
                        const dateStr = formatCrossingDate(timestamp);

                        crossingAnnotations[`crossing${idx}`] = {
                            type: 'label',
                            xValue: timestamp,
                            yValue: crossing.value,
                            backgroundColor: 'rgba(255, 0, 0, 0.9)',
                            color: 'white',
                            content: dateStr,
                            font: {
                                size: 10,
                                weight: 'bold'
                            },
                            padding: 4,
                            borderRadius: 3,
                            yAdjust: -20
                        };
                    }
                });
            }

            new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        annotation: {
                            annotations: {
                                alarmZone: {
                                    type: 'box',
                                    yMin: 0,
                                    yMax: alarmMin,
                                    backgroundColor: 'rgba(255, 0, 0, 0.1)',
                                    borderColor: 'rgba(255, 0, 0, 0.3)',
                                    borderWidth: 1,
                                    label: {
                                        display: true,
                                        content: 'Low Stock Zone',
                                        position: 'start',
                                        color: 'rgba(255, 0, 0, 0.8)',
                                        font: {
                                            size: 10
                                        }
                                    }
                                },
                                alarmLine: {
                                    type: 'line',
                                    yMin: alarmMin,
                                    yMax: alarmMin,
                                    borderColor: 'rgba(255, 0, 0, 0.5)',
                                    borderWidth: 2,
                                    borderDash: [6, 6]
                                },
                                nowLine: {
                                    type: 'line',
                                    xMin: new Date(),
                                    xMax: new Date(),
                                    borderColor: 'rgba(0, 0, 0, 0.5)',
                                    borderWidth: 2,
                                    borderDash: [3, 3],
                                    label: {
                                        display: true,
                                        content: 'Now',
                                        position: 'start',
                                        backgroundColor: 'rgba(0, 0, 0, 0.7)',
                                        color: 'white',
                                        font: {
                                            size: 10
                                        }
                                    }
                                },
                                ...crossingAnnotations
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 10,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                displayFormats: {
                                    hour: 'dd/MM HH:mm'
                                },
                                tooltipFormat: 'dd/MM HH:mm'
                            },
                            adapters: {
                                date: {
                                    zone: 'local'
                                }
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: {
                                    size: 10
                                }
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            // Add trend direction indicator
            const trendSpan = document.getElementById('trend-' + beverageId);
            if (trendResult.trendDirection === 'down') {
                trendSpan.innerHTML = '<i class=\"bi bi-arrow-down-circle-fill text-danger\" title=\"Decreasing\"></i>';
            } else if (trendResult.trendDirection === 'up') {
                trendSpan.innerHTML = '<i class=\"bi bi-arrow-up-circle-fill text-success\" title=\"Increasing\"></i>';
            } else {
                trendSpan.innerHTML = '<i class=\"bi bi-dash-circle-fill text-secondary\" title=\"Stable\"></i>';
            }

            // Check if current stock is below alarm minimum
            const currentQuantity = data.data[data.data.length - 1];
            const cardElement = document.getElementById('card-' + beverageId);
            if (currentQuantity < alarmMin) {
                cardElement.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
                cardElement.style.borderColor = '#dc3545';
                cardElement.style.borderWidth = '2px';
            }
        }
    })();
    {% endfor %}
    // Create combined chart with all beverages
    (function() {
        const ctx = document.getElementById('chart-combined').getContext('2d');
        const datasets = [];

        // Create a dataset for each beverage
        {% for beverage in all_beverages %}
        (function() {
            const beverageId = {{ beverage.id }};
            const data = chartData[beverageId];

            if (data && data.labels && data.labels.length > 0) {
                const beverageColor = data.color || 'rgb(54, 162, 235)';
                const litersPerUnit = data.liters_per_unit || 1;

                // Convert quantities to liters for combined chart
                const dataInLiters = data.data.map(qty => qty * litersPerUnit);

                // Create data array using utility function
                const beverageData = createTimeSeriesData(data.labels, dataInLiters);

                datasets.push({
                    label: '{{ beverage.name|title }}',
                    data: beverageData,
                    borderColor: beverageColor,
                    backgroundColor: beverageColor.replace('rgb', 'rgba').replace(')', ', 0.1)'),
                    tension: 0.4,
                    fill: false,
                    borderWidth: 2,
                    pointRadius: 3,
                    pointHoverRadius: 5
                });
            }
        })();
        {% endfor %}

        new Chart(ctx, {
            type: 'line',
            data: {
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 15,
                            font: {
                                size: 12
                            }
                        }
                    },
                    title: {
                        display: false
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'hour',
                            displayFormats: {
                                hour: 'dd/MM HH:mm'
                            },
                            tooltipFormat: 'dd/MM HH:mm'
                        },
                        adapters: {
                            date: {
                                zone: 'local'
                            }
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45,
                            font: {
                                size: 10
                            }
                        },
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Liters',
                            font: {
                                size: 12
                            }
                        },
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(2) + 'L';
                            }
                        }
                    }
                }
            }
        });
    })();});
</script>
{% endif %}
{% endblock %}
